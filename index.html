<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Comercial - Policryl</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* === RESET E VARIÁVEIS GLOBAIS === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Paleta Profissional Dark Neon */
            --bg-main: #0a0a14; /* Fundo ultra escuro */
            --bg-secondary: #111122; /* Fundo secundário */
            
            /* Cores dos Cartões (Glassmorphism) */
            --card-bg: rgba(20, 20, 40, 0.7);
            --card-border: rgba(255, 255, 255, 0.08);
            --card-blur: blur(12px);

            /* Cores de Texto */
            --text-primary: #ffffff;
            --text-secondary: #94a3b8; /* Cinza azulado */
            --text-muted: #64748b;

            /* Cores de Acento (Neon Glow) */
            --accent-primary: #6366f1; /* Indigo neon */
            --accent-success: #22c55e; /* Verde neon */
            --accent-warning: #f59e0b; /* Laranja/Amarelo neon */
            --accent-danger: #ef4444;  /* Vermelho neon */
            --accent-info: #0ea5e9;    /* Azul claro neon */

            /* Cores de Franquias (Vibrantes) */
            --color-bc: #ff6b35;
            --color-cs: #8b4513; /* Ajustado para um marrom mais rico */
            --color-kp: #ff1493; /* Rosa vibrante */
            --color-pb: #ffd700;
            --color-id: #1e90ff;
        }

        body {
            font-family: 'Inter', sans-serif;
            /* Fundo com gradiente sutil e profundo */
            background: radial-gradient(circle at top center, #1a1a2e 0%, #0a0a14 100%);
            color: var(--text-primary);
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px; /* Aumentei um pouco para telas modernas */
            margin: 0 auto;
        }

        /* === LOADING === */
        .loading {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10, 10, 20, 0.95);
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 20px; z-index: 9999;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 15px var(--accent-primary);
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 16px; color: var(--accent-primary); font-weight: 600; letter-spacing: 1px; }

        /* === HEADER MODERNIZADO === */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 20px 25px;
            background: var(--card-bg);
            backdrop-filter: var(--card-blur);
            border-radius: 16px;
            border: 1px solid var(--card-border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            /* Correção fundamental: */
            position: relative; 
            z-index: 1000; 
        }

        .logo-section { display: flex; align-items: center; gap: 20px; }
        .logo img { height: 65px; width: auto; filter: drop-shadow(0 0 5px rgba(255,255,255,0.3)); }
        
        /* Filtros Estilizados */
        .filters { display: flex; gap: 15px; align-items: center; }
        .filter-group { display: flex; flex-direction: column; gap: 6px; }
        .filter-group label {
            font-size: 10px; color: var(--text-secondary); text-transform: uppercase; font-weight: 700; letter-spacing: 0.8px;
        }
        .filter-group select {
            background: rgba(30, 30, 50, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--text-primary);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px; font-weight: 500;
            cursor: pointer; transition: all 0.3s ease;
            outline: none; min-width: 140px;
            /* Ícone customizado do select (opcional, requer SVG) -> appearance: none; */
        }
        .filter-group select:hover, .filter-group select:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.4);
            background: rgba(40, 40, 70, 0.9);
        }

        /* === GAUGE (VELOCÍMETRO) PROFISSIONAL === */
        /* Área superior dividida: Gauge + Header */
        .top-summary-area {
            display: grid;
            grid-template-columns: 1.2fr 2fr; /* Gauge ocupa menos espaço */
            gap: 25px;
            margin-bottom: 30px;
            align-items: stretch;
        }

        /* Container do Gauge */
       .gauge-card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Alinha tudo ao topo */
            align-items: center;
            height: 100%;
            min-height: 280px;
            position: relative;
            overflow: hidden; /* Evita que o brilho vaze */
        }

        /* Container dos Gráficos */
        .canvas-wrapper {
            position: relative;
            width: 100%;
            max-width: 450px;
            aspect-ratio: 2 / 1; /* Mantém a proporção de semicírculo */
            margin-bottom: -50px; /* Puxa o texto para cima, aproximando-o do arco */
            z-index: 1; /* Fica atrás do texto */
        }

        /* Força os canvas a ocuparem o mesmo espaço */
        .canvas-wrapper canvas {
            position: absolute !important;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }

        /* Camadas: Frente e Fundo */
        #gaugeChart { z-index: 2; filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3)); /* Brilho sutil no gráfico */ }
        #gaugeBackground { z-index: 1; }

        /* Container de Texto Alinhado na Base */
        .gauge-text-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-end; /* Alinha os textos pela linha de base inferior */
            width: 100%;
            max-width: 480px; /* Um pouco mais largo que o gráfico para os rótulos */
            padding: 0 15px;
            z-index: 2; /* Fica na frente do gráfico */
            margin-top: auto; /* Empurra para a parte inferior do card */
            padding-bottom: 10px;
        }

        /* Rótulos Laterais (R$ 0 e Meta) */
        .gauge-side-label {
            font-size: 16px;
            font-weight: 800;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 50px; /* Ajuste fino para alinhar com a base do valor central */
        }

        /* Texto Central */
        .gauge-center-text {
            text-align: center;
        }

        /* Valor Principal com Efeito Neon */
        .gauge-main-value {
            font-size: 36px;
            font-weight: 900;
            color: #fff;
            /* Sombra de texto múltipla para efeito neon mais forte */
            text-shadow: 
                0 0 5px #fff,
                0 0 10px #fff,
                0 0 20px #0fa, /* Tom esverdeado/azulado para o brilho */
                0 0 40px #0fa;
            line-height: 1;
            margin-bottom: 5px;
        }

        .gauge-sub-label {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            opacity: 0.8;
        }

        .gauge-meta-target {
            font-size: 13px; color: var(--text-muted); margin-top: 4px; font-weight: 500;
        }


        /* === KPIS GRID (Estilo Neon Glow) === */
        .kpis-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 por linha na área superior */
            gap: 20px;
            align-content: start;
        }

        .kpi-card {
            background: var(--card-bg);
            backdrop-filter: var(--card-blur);
            border-radius: 16px;
            padding: 24px 20px;
            border: 1px solid var(--card-border);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex; flex-direction: column; justify-content: center;
        }

        /* Efeito de Hover e Glow */
        .kpi-card:hover { transform: translateY(-3px); }

        /* Bordas brilhantes baseadas no tipo */
        .kpi-card.primary { box-shadow: inset 0 0 0 1px rgba(99, 102, 241, 0.3), 0 4px 20px rgba(99, 102, 241, 0.15); }
        .kpi-card.success { box-shadow: inset 0 0 0 1px rgba(34, 197, 94, 0.3), 0 4px 20px rgba(34, 197, 94, 0.15); }
        .kpi-card.warning { box-shadow: inset 0 0 0 1px rgba(245, 158, 11, 0.3), 0 4px 20px rgba(245, 158, 11, 0.15); }
        .kpi-card.danger  { box-shadow: inset 0 0 0 1px rgba(239, 68, 68, 0.3), 0 4px 20px rgba(239, 68, 68, 0.15); }
        .kpi-card.info    { box-shadow: inset 0 0 0 1px rgba(14, 165, 233, 0.3), 0 4px 20px rgba(14, 165, 233, 0.15); }

        /* Pequena barra de acento superior */
        .kpi-card::before {
            content: ''; position: absolute; top: 0; left: 30%; right: 30%; height: 2px;
            background: currentColor; box-shadow: 0 0 10px currentColor; opacity: 0.7; border-radius: 0 0 10px 10px;
        }
        .kpi-card.primary { color: var(--accent-primary); }
        .kpi-card.success { color: var(--accent-success); }
        .kpi-card.warning { color: var(--accent-warning); }
        .kpi-card.danger  { color: var(--accent-danger); }
        .kpi-card.info    { color: var(--accent-info); }

        .kpi-label { font-size: 11px; text-transform: uppercase; font-weight: 700; color: var(--text-secondary); margin-bottom: 12px; letter-spacing: 0.5px; }
        .kpi-value { font-size: 26px; font-weight: 800; color: var(--text-primary); margin-bottom: 6px; }
        .kpi-subtitle { font-size: 12px; color: var(--text-muted); font-weight: 500; }

        /* === GRÁFICOS E HISTÓRICO === */
        .section-row { margin-bottom: 30px; }
        .chart-card {
            background: var(--card-bg);
            backdrop-filter: var(--card-blur);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--card-border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .chart-title { font-size: 15px; font-weight: 700; margin-bottom: 25px; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
        .chart-title i { font-size: 18px; color: var(--accent-primary); }

        .historico-chart { height: 350px; }
        .charts-3-col { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .chart-container-small { position: relative; height: 250px; }

        /* === FRANQUIAS GRID (Estilo Glass + Marca Glow) === */
        .franquias-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 30px; }

        .franquia-card {
            background: var(--card-bg);
            backdrop-filter: var(--card-blur);
            border-radius: 18px;
            padding: 20px;
            border: 1px solid var(--card-border);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .franquia-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.3); }

        /* Glow da marca na borda superior */
        .franquia-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: var(--brand-color); box-shadow: 0 0 15px var(--brand-color);
        }

        /* Cores Específicas das Franquias (Definidas via variável inline no HTML) */
        .franquia-card.bc { --brand-color: var(--color-bc); }
        .franquia-card.cs { --brand-color: var(--color-cs); }
        .franquia-card.kp { --brand-color: var(--color-kp); }
        .franquia-card.pb { --brand-color: var(--color-pb); }
        .franquia-card.id { --brand-color: var(--color-id); }

        .franquia-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); }
        .franquia-icon {
            width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 800; color: #fff;
            background: linear-gradient(135deg, var(--brand-color), color-mix(in srgb, var(--brand-color) 60%, black));
            box-shadow: 0 4px 10px color-mix(in srgb, var(--brand-color) 40%, transparent);
        }
        .franquia-name { font-size: 15px; font-weight: 700; color: var(--text-primary); }

        .metric-row { display: flex; justify-content: space-between; align-items: center; padding: 7px 0; }
        .metric-label { font-size: 11px; color: var(--text-secondary); font-weight: 600; }
        .metric-value { font-size: 14px; font-weight: 700; color: var(--text-primary); }
        .metric-value.highlight { font-size: 16px; color: var(--accent-success); text-shadow: 0 0 10px rgba(34, 197, 94, 0.3); }

        /* Barra de Conversão Moderna */
        .conversion-bar { margin-top: 18px; }
        .conversion-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 11px; font-weight: 600; }
        .conversion-track {
            height: 6px; background: rgba(255, 255, 255, 0.08); border-radius: 10px; overflow: hidden;
        }
        .conversion-fill {
            height: 100%; border-radius: 10px; transition: width 1s ease-out;
            background: linear-gradient(90deg, var(--brand-color), color-mix(in srgb, var(--brand-color) 80%, white));
            box-shadow: 0 0 10px var(--brand-color);
        }

        /* === RESPONSIVO === */
        @media (max-width: 1400px) {
            .top-summary-area { grid-template-columns: 1fr; gap: 20px; }
            .gauge-card { padding: 20px; }
            .kpis-grid { grid-template-columns: repeat(3, 1fr); }
            .franquias-grid { grid-template-columns: repeat(3, 1fr); }
            .charts-3-col { grid-template-columns: 1fr 1fr; }
            .charts-3-col > div:last-child { grid-column: span 2; }
        }

        @media (max-width: 992px) {
             .kpis-grid { grid-template-columns: repeat(2, 1fr); }
             .franquias-grid { grid-template-columns: repeat(2, 1fr); }
             .charts-3-col { grid-template-columns: 1fr; }
             .charts-3-col > div:last-child { grid-column: span 1; }
        }

        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 15px; align-items: flex-start; }
            .filters { width: 100%; justify-content: space-between; flex-wrap: wrap; }
            .filter-group { flex: 1; min-width: 120px; }
            .kpis-grid, .franquias-grid { grid-template-columns: 1fr; }
        }

        /* Container do Filtro Único */
        .filter-wrapper {
            position: relative;
        }

        /* Botão Filtros mais fino e discreto */
        .filter-trigger {
            background: transparent;
            border: 1px solid rgba(99, 102, 241, 0.6);
            color: #ffffff;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            min-width: 130px;
            justify-content: space-between;
            transition: all 0.3s;
        }

        .filter-trigger:hover {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }

        /* Menu Suspenso (Dropdown) */
        .filter-dropdown {
            position: absolute;
            top: calc(100% + 15px); /* Espaço abaixo do botão */
            right: 0;
            background: #111122; /* Fundo sólido para não transparecer o que está atrás */
            border: 2px solid var(--accent-primary);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); /* Sombra mais pesada para dar profundidade */
            display: none;
            flex-direction: column;
            gap: 15px;
            min-width: 300px;
            
            /* Z-INDEX ALTÍSSIMO para ficar na frente de tudo */
            z-index: 9999 !important; 
            backdrop-filter: blur(20px);
        }

        /* Classe que será adicionada via JS para mostrar o menu */
        .filter-dropdown.active {
            display: flex !important;
            animation: fadeInDown 0.3s ease;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Ajuste dos selects dentro do menu */
        .filter-dropdown .filter-group select {
            width: 100%;
            background: rgba(255,255,255,0.05);
        }
        .btn-apply {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn-apply:hover {
            filter: brightness(1.2);
            box-shadow: 0 0 15px var(--accent-primary);
        }

        /* Estilo do Toggle de Tema */
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch {
            display: inline-block; height: 34px; position: relative; width: 60px;
        }
        .theme-switch input { display:none; }
        .slider {
            background-color: #4b7bec; border-radius: 34px; bottom: 0; cursor: pointer;
            left: 0; position: absolute; right: 0; top: 0; transition: .4s;
            display: flex; align-items: center; padding: 0 5px;
        }
        .slider:before {
            background-color: #fff; border-radius: 50%; content: ""; height: 26px;
            position: absolute; transition: .4s; width: 26px; left: 4px; z-index: 2;
        }

        input:checked + .slider { background-color: #4b7bec; }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider i { color: white; margin-left: auto; font-size: 18px; }

        /* Cronômetro Refresh */
        .update-container { display: flex; flex-direction: column; align-items: center; }
        

        /* Ajuste de cor do menu suspenso conforme imagem (Fundo escuro, borda neon) */
        .filter-dropdown {
            display: none; 
            position: absolute;
            top: calc(100% + 15px);
            right: 0;
            background: #1a1a2e; /* Azul marinho escuro conforme sua imagem */
            border: 2px solid #6366f1;
            padding: 20px;
            border-radius: 16px;
            z-index: 9999; /* Fica na frente de tudo */
            min-width: 280px;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Ajuste dos Selects para não ficarem com fundo branco bugado */
        select option {
            background-color: #1a1a2e;
            color: white;
        }
        /* Garante que o fundo do select seja escuro quando aberto */
        select {
            background-color: #111122 !important;
            color: white !important;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Container de Controles Alinhados */
        .header-controls {
            display: flex;
            align-items: flex-start; /* Alinha o topo dos botões */
            gap: 12px;
        }

        .control-item {
            position: relative; /* Base para o timer e dropdowns */
        }

        /* Ajuste do Texto de Refresh (Ciano e Centralizado) */
        .update-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .refresh-timer {
            color: #00d4ff; /* Ciano das imagens */
            font-size: 10px;
            font-weight: 800;
            margin-top: 8px;
            letter-spacing: 0.5px;
            font-family: monospace;
        }

        /* === ESTILO DO TOGGLE SOL/LUA === */
        .theme-container { margin-right: 10px; }
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 54px;
            height: 28px;
        }
        .theme-switch input { opacity: 0; width: 0; height: 0; }

        .theme-slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #4b7bec; /* Azul do dark mode */
            transition: .4s; border-radius: 34px;
        }

        .icon-container {
            position: absolute;
            height: 22px; width: 22px;
            left: 4px; bottom: 3px;
            background-color: white;
            transition: .4s; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }

        /* Ícones dentro do círculo branco */
        .icon-container i { font-size: 16px; transition: .4s; }
        .sun-icon { color: #f1c40f; display: none; }
        .moon-icon { color: #4b7bec; display: block; }

        /* === CSS DO TOGGLE (CORRIGIDO) === */
        .theme-switch { position: relative; display: inline-block; width: 50px; height: 26px; margin-top: 5px; }
        .theme-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4b7bec; border-radius: 34px; transition: .4s; }
        .icon-container { position: absolute; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .4s; display: flex; align-items: center; justify-content: center; }
        input:not(:checked) + .theme-slider { background-color: #ccc; }
        input:not(:checked) + .theme-slider .icon-container { transform: translateX(24px); }
        .sun-icon { color: #f1c40f; display: none; }
        .moon-icon { color: #4b7bec; display: block; }
        input:not(:checked) + .theme-slider .sun-icon { display: block; }
        input:not(:checked) + .theme-slider .moon-icon { display: none; }

        .control-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        /* Ajuste do Wrapper para segurar dois canvas */
        .canvas-wrapper {
            position: relative;
            width: 300px;
            height: 150px;
            margin: 0 auto 10px auto; /* Centralizado */
        }

        /* Força os canvas a ocuparem o mesmo espaço */
        .canvas-wrapper canvas {
            position: absolute !important;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }

        /* Camadas: Frente e Fundo */
        #gaugeChart { z-index: 2; }
        #gaugeBackground { z-index: 1; }

        /* Etiquetas nos cantos (R$ 0 e Meta) */
        .gauge-labels-container {
            width: 100%;
            max-width: 320px;
            display: flex;
            justify-content: space-between;
            position: absolute;
            bottom: 100px; /* Ajuste conforme altura do seu card */
            z-index: 3;
            pointer-events: none; /* Deixa clicar através do texto */
            font-size: 12px;
            font-weight: 700;
            color: var(--text-muted);
        }

        .gauge-card { position: relative; }
        .gauge-labels {
            position: absolute;
            top: 130px; /* Ajuste vertical para alinhar com a base do arco */
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            z-index: 3;
            pointer-events: none;
        }
        
        /* Ajuste fino para "empurrar" os textos para fora do arco */
        .gauge-card { position: relative; } /* Contexto para o absolute */
        .gauge-corner-label {
            position: absolute;
            bottom: 130px; /* Alinha com a base do arco */
        }
        .gauge-corner-label.left { left: 20px; }
        .gauge-corner-label.right { right: 20px; text-align: right; }

        /* Valor Principal com Brilho */
        .gauge-main-value {
            font-size: 28px;
            font-weight: 800;
            color: #fff;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }

        /* === EFEITO META BATIDA (TROFÉU) === */
        /* O Selo do Troféu (Escondido por padrão) */
        .trophy-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #FFD700, #FFA500); /* Degradê Dourado */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #fff;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
            z-index: 10;
            
            /* Animação de entrada (Pop) */
            transform: scale(0) rotate(-45deg);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
        }

        /* Quando a classe 'meta-batida' é adicionada via JS */
        .kpi-card.meta-batida {
            border: 2px solid #FFD700 !important; /* Borda Dourada mais grossa */
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.15), inset 0 0 20px rgba(255, 215, 0, 0.05) !important;
        }

        /* Faz o troféu aparecer */
        .kpi-card.meta-batida .trophy-badge {
            transform: scale(1) rotate(0deg);
            opacity: 1;
        }

        /* Muda a cor do valor para dourado */
        .kpi-card.meta-batida .kpi-value {
            color: #FFD700 !important;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        /* Ajuste para Light Mode (opcional, para garantir contraste) */
        body.light-mode .kpi-card.meta-batida {
            background: #fff;
            box-shadow: 0 10px 40px -10px rgba(255, 215, 0, 0.3) !important;
        }
        .franquia-icon img {
            display: block;
            max-width: 100%;
            max-height: 100%;
        }

        /* Se quiser remover o fundo colorido original para o SVG aparecer melhor */
        .franquia-card.bc .franquia-icon { background: transparent; box-shadow: none; }
        .franquia-card.cs .franquia-icon { background: transparent; box-shadow: none; }
        .franquia-card.kp .franquia-icon { background: transparent; box-shadow: none; }
        .franquia-card.id .franquia-icon { background: transparent; box-shadow: none; }
        .franquia-card.pb .franquia-icon { background: transparent; box-shadow: none; }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Carregando dados...</div>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo-section">
                <div class="logo">
                    <img src="assets/img/logo-policryl-white.svg" alt="Logo Policryl" id="logoImg">
                </div>
            </div>
            
            <div class="header-controls">
                <div class="theme-container">
                    <label class="theme-switch">
                        <input type="checkbox" id="themeCheckbox" onchange="toggleTheme()" checked>
                        <div class="theme-slider">
                            <div class="icon-container">
                                <i class="ph-bold ph-sun-dim sun-icon"></i>
                                <i class="ph-bold ph-moon moon-icon"></i>
                            </div>
                        </div>
                    </label>
                </div>

                <div class="control-wrapper">
                    <button class="filter-trigger" onclick="toggleMenu('filterMenu', 'filterIcon')">
                        <span>Filtros</span>
                        <i class="ph-bold ph-caret-down" id="filterIcon"></i>
                    </button>
                    <div class="filter-dropdown" id="filterMenu">
                        <div class="filter-group">
                            <label>Ano</label>
                            <select id="filterAno">
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026" selected>2026</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Mês</label>
                            <select id="filterMes"></select>
                        </div>
                        <div class="filter-group">
                            <label>Linha/Franquia</label>
                            <select id="filterLinha">
                                <option value="todas">Todas as Linhas</option>
                                <option value="FRA - Brasil Cacau">Brasil Cacau</option>
                                <option value="FRA - Cacau Show">Cacau Show</option>
                                <option value="FRA - Kopenhagen">Kopenhagen</option>
                                <option value="IND - Industries">Industries</option>
                                <option value="PLB - PolyBee">PolyBee</option>
                            </select>
                        </div>
                        <button class="btn-apply" onclick="applyAndClose()">APLICAR</button>
                    </div>
                </div>

                <div class="control-wrapper update-column">
                    <button class="filter-trigger" onclick="toggleMenu('updateMenu', 'updateIcon')">
                        <span>Atualização</span>
                        <i class="ph-bold ph-caret-down" id="updateIcon"></i>
                    </button>
                    <div class="refresh-timer" id="timerDisplay">REFRESH EM: 00:00</div>
                    
                    <div class="filter-dropdown" id="updateMenu">
                        <div class="filter-group">
                            <label>Intervalo</label>
                            <select id="updateInterval" onchange="setNewInterval()">
                                <option value="30000">30 seg</option>
                                <option value="60000">1 min</option>
                                <option value="120000">2 min</option>
                                <option value="300000" selected>5 min</option>
                                <option value="600000">10 min</option>
                                <option value="900000">15 min</option>
                                <option value="1800000">30 min</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <div class="top-summary-area">    
            <div class="gauge-card">
                <div class="canvas-wrapper">
                    <canvas id="gaugeBackground"></canvas> <canvas id="gaugeChart"></canvas>      </div>
                
                <div class="gauge-text-container">
                    <span id="gaugeLabelMin" class="gauge-side-label">R$ 0,00</span>
                    
                    <div class="gauge-center-text">
                        <div class="gauge-main-value" id="gaugeValor">R$ 0,00</div>
                        <div class="gauge-sub-label">TOTAL VENDIDO (ANO)</div>
                    </div>
                    
                    <span id="gaugeLabelMax" class="gauge-side-label">R$ 0M</span>
                </div>
            </div>
            <div class="kpis-grid">
                <div class="kpi-card primary">
                    <div class="kpi-label">Meta do Mês</div>
                    <div class="kpi-value" id="metaMes">R$ 0</div>
                    <div class="kpi-subtitle" id="mesRef">--/--</div>
                </div>
                <div class="kpi-card primary" id="cardMetaDiaria">
                    <div class="trophy-badge"><i class="ph-fill ph-trophy"></i></div>
                    <div class="kpi-label">Status da Meta</div>
                    <div class="kpi-value" id="metaDia">Calculando...</div>
                    <div class="kpi-subtitle">Análise diária</div>
                </div>
                <div class="kpi-card success">
                    <div class="kpi-label">Valor em Vendas</div>
                    <div class="kpi-value" id="valorVendas">R$ 0</div>
                    <div class="kpi-subtitle">Total vendido no Mês</div>
                </div>
                <div class="kpi-card warning">
                    <div class="kpi-label">Pedidos em Casa</div>
                    <div class="kpi-value" id="pedidosLiberar">0</div>
                    <div class="kpi-subtitle">Aguardando Aprovação</div>
                </div>
                <div class="kpi-card danger">
                    <div class="kpi-label">Pedidos à Liberar</div>
                    <div class="kpi-value" id="pedidosAtraso">0</div>
                    <div class="kpi-subtitle">Atenção Necessária</div>
                </div>
                <div class="kpi-card info">
                    <div class="kpi-label">Pedidos Faturados</div>
                    <div class="kpi-value" id="pedidosExpedidos">0</div>
                    <div class="kpi-subtitle">Expedição/Expedidos</div>
                </div>
            </div>
        </div>

        <div class="section-row">
            <div class="franquias-grid">
                <div class="franquia-card bc">
                    <div class="franquia-header">
                        <div class="franquia-icon">
                            <img src="assets/clients/brasilcacau-square.svg" alt="Brasil Cacau" style="width: 100%; height: 100%; object-fit: contain; padding: 4px;">
                        </div>
                        <div class="franquia-name">Brasil Cacau</div>
                    </div>
                    <div class="franquia-metrics">
                        <div class="metric-row"><span class="metric-label">Nº Orçamentos</span><span class="metric-value" id="bc-qtd-orc">0</span></div>
                        <div class="metric-row"><span class="metric-label">Valor Orç.</span><span class="metric-value" id="bc-val-orc">R$ 0</span></div>
                        <div class="metric-row"><span class="metric-label">Nº Pedidos</span><span class="metric-value" id="bc-qtd-ped">0</span></div>
                        <div class="metric-row"><span class="metric-label">Venda</span><span class="metric-value highlight" id="bc-val-ped">R$ 0</span></div>
                        <div class="metric-row"><span class="metric-label">Ticket Méd.</span><span class="metric-value" id="bc-ticket">R$ 0</span></div>
                    </div>
                    <div class="conversion-bar">
                        <div class="conversion-label">
                            <span style="color: var(--text-secondary);">Conversão ($)</span>
                            <span style="color: var(--text-primary); font-weight: 700;" id="bc-conversao">0%</span>
                        </div>
                        <div class="conversion-track"><div class="conversion-fill" id="bc-conversao-bar" style="width:0%"></div></div>
                    </div>
                </div>

                <div class="franquia-card cs">
                    <div class="franquia-header">
                        <div class="franquia-icon">
                            <img src="assets/clients/cacaushow-square.svg" alt="Cacau Show" style="width: 100%; height: 100%; object-fit: contain; padding: 4px;">
                        </div>
                        <div class="franquia-name">Cacau Show</div>
                    </div>
                    <div class="franquia-metrics">
                        <div class="metric-row"><span class="metric-label">Nº Orçamentos</span><span class="metric-value" id="cs-qtd-orc">0</span></div>
                        <div class="metric-row"><span class="metric-label">Valor Orç.</span><span class="metric-value" id="cs-val-orc">R$ 0</span></div>
                        <div class="metric-row"><span class="metric-label">Nº Pedidos</span><span class="metric-value" id="cs-qtd-ped">0</span></div>
                        <div class="metric-row"><span class="metric-label">Venda</span><span class="metric-value highlight" id="cs-val-ped">R$ 0</span></div>
                        <div class="metric-row"><span class="metric-label">Ticket Méd.</span><span class="metric-value" id="cs-ticket">R$ 0</span></div>
                    </div>
                    <div class="conversion-bar">
                        <div class="conversion-label">
                            <span style="color: var(--text-secondary);">Conversão ($)</span>
                            <span style="color: var(--text-primary); font-weight: 700;" id="cs-conversao">0%</span>
                        </div>
                        <div class="conversion-track"><div class="conversion-fill" id="cs-conversao-bar" style="width:0%"></div></div>
                    </div>
                </div>

                <div class="franquia-card kp">
                    <div class="franquia-header">
                        <div class="franquia-icon">
                            <img src="assets/clients/kopenhagen-square.svg" alt="Kopenhagen" style="width: 100%; height: 100%; object-fit: contain; padding: 4px;">
                        </div>
                        <div class="franquia-name">Kopenhagen</div>
                    </div>
                    <div class="franquia-metrics">
                        <div class="metric-row"><span class="metric-label">Nº Orçamentos</span><span class="metric-value" id="kp-qtd-orc">0</span></div>
                        <div class="metric-row"><span class="metric-label">Valor Orç.</span><span class="metric-value" id="kp-val-orc">R$ 0</span></div>
                        <div class="metric-row"><span class="metric-label">Nº Pedidos</span><span class="metric-value" id="kp-qtd-ped">0</span></div>
                        <div class="metric-row"><span class="metric-label">Venda</span><span class="metric-value highlight" id="kp-val-ped">R$ 0</span></div>
                        <div class="metric-row"><span class="metric-label">Ticket Méd.</span><span class="metric-value" id="kp-ticket">R$ 0</span></div>
                    </div>
                    <div class="conversion-bar">
                        <div class="conversion-label">
                            <span style="color: var(--text-secondary);">Conversão ($)</span>
                            <span style="color: var(--text-primary); font-weight: 700;" id="kp-conversao">0%</span>
                        </div>
                        <div class="conversion-track"><div class="conversion-fill" id="kp-conversao-bar" style="width:0%"></div></div>
                    </div>
                </div>

                <div class="franquia-card id">
                    <div class="franquia-header">
                        <div class="franquia-icon">
                            <img src="assets/clients/industries-square.svg" alt="Industries" style="width: 100%; height: 100%; object-fit: contain; padding: 4px;">
                        </div>
                        <div class="franquia-name">Industries</div>
                    </div>
                    <div class="franquia-metrics">
                        <div class="metric-row"><span class="metric-label">Nº Orçamentos</span><span class="metric-value" id="id-qtd-orc">0</span></div>
                        <div class="metric-row"><span class="metric-label">Valor Orç.</span><span class="metric-value" id="id-val-orc">R$ 0</span></div>
                        <div class="metric-row"><span class="metric-label">Nº Pedidos</span><span class="metric-value" id="id-qtd-ped">0</span></div>
                        <div class="metric-row"><span class="metric-label">Venda</span><span class="metric-value highlight" id="id-val-ped">R$ 0</span></div>
                        <div class="metric-row"><span class="metric-label">Ticket Méd.</span><span class="metric-value" id="id-ticket">R$ 0</span></div>
                    </div>
                    <div class="conversion-bar">
                        <div class="conversion-label">
                            <span style="color: var(--text-secondary);">Conversão ($)</span>
                            <span style="color: var(--text-primary); font-weight: 700;" id="id-conversao">0%</span>
                        </div>
                        <div class="conversion-track"><div class="conversion-fill" id="id-conversao-bar" style="width:0%"></div></div>
                    </div>
                </div>

                <div class="franquia-card pb">
                    <div class="franquia-header">
                        <div class="franquia-icon">
                            <img src="assets/clients/polybee-square.svg" alt="PolyBee" style="width: 100%; height: 100%; object-fit: contain; padding: 4px;">
                        </div>
                        <div class="franquia-name">PolyBee</div>
                    </div>
                    <div class="franquia-metrics">
                        <div class="metric-row"><span class="metric-label">Nº Orçamentos</span><span class="metric-value" id="pb-qtd-orc">0</span></div>
                        <div class="metric-row"><span class="metric-label">Valor Orç.</span><span class="metric-value" id="pb-val-orc">R$ 0</span></div>
                        <div class="metric-row"><span class="metric-label">Nº Pedidos</span><span class="metric-value" id="pb-qtd-ped">0</span></div>
                        <div class="metric-row"><span class="metric-label">Venda</span><span class="metric-value highlight" id="pb-val-ped">R$ 0</span></div>
                        <div class="metric-row"><span class="metric-label">Ticket Méd.</span><span class="metric-value" id="pb-ticket">R$ 0</span></div>
                    </div>
                    <div class="conversion-bar">
                        <div class="conversion-label">
                            <span style="color: var(--text-secondary);">Conversão ($)</span>
                            <span style="color: var(--text-primary); font-weight: 700;" id="pb-conversao">0%</span>
                        </div>
                        <div class="conversion-track"><div class="conversion-fill" id="pb-conversao-bar" style="width:0%"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-row">
            <div class="chart-card historico-card">
                <div class="chart-title"><i class="ph-bold ph-chart-line-up"></i> Histórico Mensal: Orçamentos vs Vendas vs Meta</div>
                <div class="historico-chart">
                    <canvas id="historicoChart"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-3-col">
            <div class="chart-card">
                <div class="chart-title"><i class="ph-bold ph-credit-card"></i> Formas de Pagamento</div>
                <div class="chart-container-small">
                    <canvas id="pagamentoChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title"><i class="ph-bold ph-map-pin"></i> Pedidos por Região</div>
                <div class="chart-container-small">
                    <canvas id="regiaoChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title"><i class="ph-bold ph-arrows-counter-clockwise"></i> Primeira vs Recompra</div>
                <div class="chart-container-small">
                    <canvas id="compraChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        

        // ================= CONFIGURAÇÕES GLOBAIS =================
        const CSV_URL_DASH = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKstKflONSWvQ6xfVkMdM53mveopLXVGNv9CyQT0kRbjdI7IGIVzvvMPLSXNyQ-xZTQEvDmKr1jI_I/pub?gid=1199309873&single=true&output=csv';

        // NOVAS METAS TRIMESTRAIS (Fundamental para o gráfico novo)
        const METAS_TRIMESTRAIS = {
            "2024": [1500000, 1500000, 1500000, 1500000],
            "2025": [1974456.66, 1974456.66, 1974456.66, 1974456.68],
            "2026": [2053434.18, 2088899.83, 2709257.11, 2148408.87]
        };

        const METAS_ANUAIS = {
            "2024": 6000000.00, "2025": 7897826.66, "2026": 9000000.00 
        };

        const COLS = {
            ANO:0, MES:1, LINHA:2, META_MES:3, META_DIARIA:4,
            QTDE_ORCAMENTOS:6, VALOR_ORCAMENTOS:7, QTDE_PEDIDOS:13, VALOR_PEDIDOS:14,
            PEDIDOS_PIX:19, VALORES_PIX:20, PEDIDOS_CARTAO_CREDITO:21, VALORES_CARTAO_CREDITO:22, PEDIDOS_BOLETO:23, VALORES_BOLETO:24,
            PEDIDOS_ATRASADOS:25, PEDIDOS_A_LIBERAR:27, PEDIDOS_FATURADOS_MES:28, PEDIDOS_EXPEDIDOS_MES:29,
            PRIMEIRA_COMPRA:32, RECOMPRA:33,
            REGIAO_CENTRO_OESTE:34, REGIAO_NORDESTE:35, REGIAO_NORTE:36, REGIAO_SUDESTE:37, REGIAO_SUL:38
        };

        const MESES_MAP = {'JAN':'01','FEV':'02','MAR':'03','ABR':'04','MAI':'05','JUN':'06','JUL':'07','AGO':'08','SET':'09','OUT':'10','NOV':'11','DEZ':'12'};
        const MESES_NOMES_COMPLETOS = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

        let allData = [];
        // Variáveis globais para os gráficos
        let gaugeChart, gaugeBackgroundChart, historicoChart, pagamentoChart, regiaoChart, compraChart;
        let countdownTimer, timeLeft;

        // ================= FUNÇÕES UTILITÁRIAS =================
        function formatCurrency(v){ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0); }
        function formatNumber(v){ return new Intl.NumberFormat('pt-BR').format(v||0); }
        function formatPercent(v){ return (v||0).toFixed(1)+'%'; }
        
        // Formatação compacta (ex: 9,5M)
        function formatShortCurrency(num) {
            if (num >= 1000000) return 'R$ ' + (num / 1000000).toFixed(1).replace('.', ',') + 'M';
            if (num >= 1000) return 'R$ ' + (num / 1000).toFixed(0).replace('.', ',') + 'K';
            return formatCurrency(num);
        }

        function parseValue(v){
            if (!v && v!==0) return 0;
            if (typeof v==='number') return v;
            const cleaned = String(v).replace(/[R$\s.]/g,'').replace(',','.');
            return parseFloat(cleaned)||0;
        }

        function normalizarMes(m){
            const s = String(m||'').trim().toUpperCase();
            if (MESES_MAP[s]) return MESES_MAP[s];
            const n = parseInt(s,10);
            if(!isNaN(n) && n>=1 && n<=12) return String(n).padStart(2,'0');
            return '01';
        }

        const norm = (s) => String(s ?? '').normalize('NFD').replace(/\p{Diacritic}/gu, '').trim().toLowerCase();

        function getCurrentFilters(){
            const ano = document.getElementById('filterAno').value;
            const mes = document.getElementById('filterMes').value;
            const rawLinha = document.getElementById('filterLinha').value;
            const linha = (norm(rawLinha) === 'todas') ? 'todas' : rawLinha;
            const mesNome = MESES_NOMES_COMPLETOS[parseInt(mes)-1];
            return { ano, mes, linha, mesAnoRef: `${mesNome}/${ano}` };
        }

        // ================= GESTÃO DE DADOS =================
        function csvToArray(text){
            const lines = text.split(/\r?\n/).filter(l => l.length > 0);
            return lines.map(line => {
                const out = []; let cur = '', q = false;
                for (let i=0; i<line.length; i++){
                    const ch = line[i];
                    if (ch === '"'){ if (q && line[i+1] === '"'){ cur+='"'; i++; } else { q=!q; } }
                    else if (ch === ',' && !q){ out.push(cur); cur=''; }
                    else { cur += ch; }
                }
                out.push(cur); return out;
            });
        }

        async function fetchSheetData(){
            const loadingEl = document.getElementById('loading');
            if(loadingEl) loadingEl.style.display = 'flex';
            try {
                const res = await fetch(`${CSV_URL_DASH}&cb=${Date.now()}`);
                const txt = await res.text();
                allData = csvToArray(txt).slice(1);
                return true;
            } catch(e) {
                console.error('Erro:', e);
                return false;
            } finally {
                if(loadingEl) loadingEl.style.display = 'none';
            }
        }

        function findDataRowForFilters(filters){
            const linhaFiltroNorm = norm(filters.linha);
            const dadosFiltrados = allData.filter(row => {
                const rowAno = String(row[COLS.ANO]||'').trim();
                const rowMes = normalizarMes(row[COLS.MES]);
                const rowLinha = norm(row[COLS.LINHA]);
                return rowAno === filters.ano && rowMes === filters.mes && (linhaFiltroNorm === 'todas' || rowLinha === linhaFiltroNorm);
            });

            if (dadosFiltrados.length === 0) return null;
            if (dadosFiltrados.length === 1) return dadosFiltrados[0];

            const consolidado = new Array(40).fill(0);
            dadosFiltrados.forEach(row => {
                Object.values(COLS).forEach(idx => {
                    if ([3,4,7,14,20,22,24,25,27,28,29,32,33,34,35,36,37,38].includes(idx)) consolidado[idx] += parseValue(row[idx]);
                });
            });
            return consolidado;
        }

        async function updateDashboard(forceReload = false){
            if (forceReload || allData.length === 0) await fetchSheetData();
            
            const filters = getCurrentFilters();
            const rowMensal = findDataRowForFilters(filters);
            
            // Atualiza KPIs
            document.getElementById('metaMes').textContent = formatCurrency(rowMensal ? parseValue(rowMensal[COLS.META_MES]) : 0);
            document.getElementById('valorVendas').textContent = formatCurrency(rowMensal ? parseValue(rowMensal[COLS.VALOR_PEDIDOS]) : 0);
            document.getElementById('mesRef').textContent = filters.mesAnoRef;

            // 1. Meta do Mês
            const metaMesVal = rowMensal ? parseValue(rowMensal[COLS.META_MES]) : 0;
            document.getElementById('metaMes').textContent = formatCurrency(metaMesVal);
            document.getElementById('mesRef').textContent = filters.mesAnoRef;

            // 2. Valor em Vendas (Realizado)
            const valorVendasVal = rowMensal ? parseValue(rowMensal[COLS.VALOR_PEDIDOS]) : 0;
            document.getElementById('valorVendas').textContent = formatCurrency(valorVendasVal);

            // 3. Lógica: META DIÁRIA DINÂMICA (Recálculo Inteligente)
            const faltaParaMeta = metaMesVal - valorVendasVal;
            const cardMetaLabel = document.querySelector('.kpi-card:nth-child(2) .kpi-label');
            const cardMetaSub = document.querySelector('.kpi-card:nth-child(2) .kpi-subtitle');
            const cardMetaValue = document.getElementById('metaDia');
            const cardContainer = cardMetaValue.parentElement;

            // Variáveis de Tempo
            const now = new Date();
            const anoF = parseInt(filters.ano);
            const mesF = parseInt(filters.mes);
            // Total de dias no mês selecionado (ex: Jan = 31)
            const diasNoMes = new Date(anoF, mesF, 0).getDate();
            
            let diasRestantes = 0;
            let metaDiariaNecessaria = 0;

            // Verifica se é o mês atual, passado ou futuro
            if (anoF === now.getFullYear() && mesF === (now.getMonth() + 1)) {
                // Mês Atual: Conta quantos dias faltam (incluindo hoje para ter chance de vender)
                diasRestantes = diasNoMes - now.getDate() + 1;
            } else if (now > new Date(anoF, mesF - 1, diasNoMes)) {
                // Mês Passado: Dias restantes é 0 (mês fechado)
                diasRestantes = 0;
            } else {
                // Mês Futuro: Dias restantes é o mês todo
                diasRestantes = diasNoMes;
            }

            // Evita divisão por zero
            if (diasRestantes > 0 && faltaParaMeta > 0) {
                metaDiariaNecessaria = faltaParaMeta / diasRestantes;
            }

            // === ATUALIZAÇÃO DO CARD ===
            
            if (faltaParaMeta <= 0) {
                // CENÁRIO 1: META JÁ BATIDA (Show!)
                cardContainer.className = 'kpi-card success'; // Fica verde
                cardMetaLabel.textContent = "Meta Mensal Batida!";
                cardMetaValue.textContent = "+" + formatCurrency(Math.abs(faltaParaMeta));
                cardMetaValue.style.color = '#ffffff';
                cardMetaSub.textContent = "Você superou o objetivo!";
            } 
            else if (diasRestantes === 0) {
                // CENÁRIO 2: MÊS ACABOU E NÃO BATEU (Tristeza)
                cardContainer.className = 'kpi-card danger'; // Fica vermelho
                cardMetaLabel.textContent = "Faltou para a Meta";
                cardMetaValue.textContent = formatCurrency(faltaParaMeta);
                cardMetaValue.style.color = '#ffffff';
                cardMetaSub.textContent = "Mês encerrado";
            } 
            else {
                // CENÁRIO 3: MÊS CORRENDO (O Jogo continua)
                // Aqui aplicamos a lógica que você pediu:
                // Se vendeu pouco ontem, essa 'metaDiariaNecessaria' vai subir automaticamente hoje.
                
                cardContainer.className = 'kpi-card primary'; // Cor padrão (Indigo)
                cardMetaLabel.textContent = "Meta Diária Necessária";
                cardMetaValue.textContent = formatCurrency(metaDiariaNecessaria);
                
                // Muda a cor do texto para amarelo se a meta diária necessária ficar muito alta
                // Exemplo: Se a meta diária necessária for 2x maior que a meta diária "normal" (média), alerta!
                const metaDiariaPadrao = metaMesVal / diasNoMes;
                if (metaDiariaNecessaria > (metaDiariaPadrao * 1.1)) {
                    cardMetaValue.style.color = '#f59e0b'; // Amarelo (Atenção, o acumulado está pesado)
                    cardMetaSub.textContent = "Acumulado alto! Acelerar vendas.";
                } else {
                    cardMetaValue.style.color = '#ffffff';
                    cardMetaSub.textContent = `Para bater a meta em ${diasRestantes} dias`;
                }
            }

            // Seleção direta do card pelo ID novo que criamos, ou pelo DOM se não mudou o HTML
            const cardElement = document.getElementById('cardMetaDiaria') || cardContainer;

            // Remove classes antigas para limpar o estado
            cardElement.classList.remove('primary', 'success', 'danger', 'meta-batida');

            if (faltaParaMeta <= 0) {
                // === CENÁRIO: META BATIDA (O "TCHAN") ===
                cardElement.classList.add('meta-batida'); // Ativa o CSS do troféu
                
                cardMetaLabel.textContent = "Meta Mensal Batida!";
                cardMetaValue.textContent = "+" + formatCurrency(Math.abs(faltaParaMeta));
                
                // Texto de comemoração
                cardMetaSub.innerHTML = "<i class='ph-bold ph-confetti'></i> Parabéns pelo resultado!";
                cardMetaSub.style.color = "var(--text-secondary)";
            
            } else if (diasRestantes === 0) {
                // CENÁRIO: MÊS ACABOU (Não bateu)
                cardElement.classList.add('danger');
                cardMetaLabel.textContent = "Faltou para a Meta";
                cardMetaValue.textContent = formatCurrency(faltaParaMeta);
                
                if (document.body.classList.contains('light-mode')) {
                    cardMetaValue.style.color = 'var(--accent-danger)';
                } else {
                    cardMetaValue.style.color = '#ffffff';
                }
                cardMetaSub.textContent = "Mês encerrado";

            } else {
                // CENÁRIO: MÊS CORRENDO (Normal)
                cardElement.classList.add('primary');
                cardMetaLabel.textContent = "Meta Diária Necessária";
                cardMetaValue.textContent = formatCurrency(metaDiariaNecessaria);
                
                const metaDiariaPadrao = metaMesVal / diasNoMes;
                
                // Lógica de alerta amarelo se a meta diária ficar muito alta
                if (metaDiariaNecessaria > (metaDiariaPadrao * 1.1)) {
                    if (document.body.classList.contains('light-mode')) {
                        cardMetaValue.style.color = 'var(--accent-warning)';
                    } else {
                        cardMetaValue.style.color = '#f59e0b';
                    }
                    cardMetaSub.textContent = "Acumulado alto! Acelerar vendas.";
                } else {
                    if (document.body.classList.contains('light-mode')) {
                        cardMetaValue.style.color = 'var(--text-primary)';
                    } else {
                        cardMetaValue.style.color = '#ffffff';
                    }
                    cardMetaSub.textContent = `Para bater a meta em ${diasRestantes} dias`;
                }
            }

            // Pedidos Gerais
            const linhaSelNorm = norm(filters.linha);
            const rowsGeral = allData.filter(r => (linhaSelNorm === 'todas') || (norm(r[COLS.LINHA]) === linhaSelNorm));
            document.getElementById('pedidosAtraso').textContent = formatNumber(rowsGeral.reduce((s,r) => s + parseValue(r[COLS.PEDIDOS_ATRASADOS]), 0));
            document.getElementById('pedidosLiberar').textContent = formatNumber(rowsGeral.reduce((s,r) => s + parseValue(r[COLS.PEDIDOS_A_LIBERAR]), 0));
            document.getElementById('pedidosExpedidos').textContent = formatNumber(rowMensal ? parseValue(rowMensal[COLS.PEDIDOS_EXPEDIDOS_MES]) : 0);

            // Atualiza Todos os Gráficos
            updateGaugeChart(filters.ano); // <--- AQUI ESTÁ A CORREÇÃO
            updateHistoricoChart(filters.ano);
            updatePagamentoChart(filters);
            updateRegiaoChart(filters);
            updateCompraChart(filters);
            updateFranquiasCards(filters);
        }

        // ================= FUNÇÃO DO VELOCÍMETRO COM ALINHAMENTO E GRADIENTE NEON =================
        function updateGaugeChart(ano) {
            const canvasBg = document.getElementById('gaugeBackground');
            const canvasFg = document.getElementById('gaugeChart');
            if (!canvasBg || !canvasFg) return;

            // 1. Dados
            const metas = METAS_TRIMESTRAIS[ano] || [2500000, 2500000, 2500000, 2500000];
            const metaAnual = metas.reduce((a, b) => a + b, 0);
            
            const rowsAno = allData.filter(r => String(r[COLS.ANO]).trim() === ano);
            const vendasAno = rowsAno.reduce((s, r) => s + parseValue(r[COLS.VALOR_PEDIDOS]), 0);
            
            const perc = (vendasAno / metaAnual) * 100;
            const visualPerc = Math.min(Math.max(perc, 0), 100);

            // 2. Atualiza os Textos Alinhados
            document.getElementById('gaugeValor').textContent = formatCurrency(vendasAno);
            document.getElementById('gaugeLabelMin').textContent = "R$ 0,00";
            document.getElementById('gaugeLabelMax').textContent = formatShortCurrency(metaAnual);

            const isDark = document.getElementById('themeCheckbox').checked;

            // 3. Cores de Fundo Suavizadas (Translúcidas)
            const bgQ1 = isDark ? 'rgba(255, 255, 255, 0.04)' : 'rgba(0, 0, 0, 0.04)';
            const bgQ2 = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const borderColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            // Configuração de Espessura
            const thicknessConfig = {
                cutout: '60%', 
                circumference: 180, 
                rotation: -90
            };

            // 4. Gráfico de Fundo (Trimestres)
            if (gaugeBackgroundChart) gaugeBackgroundChart.destroy();
            gaugeBackgroundChart = new Chart(canvasBg.getContext('2d'), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: metas,
                        backgroundColor: [bgQ1, bgQ2, bgQ1, bgQ2],
                        borderWidth: 1,
                        borderColor: borderColor,
                        ...thicknessConfig
                    }]
                },
                options: { 
            plugins: { tooltip: { enabled: false } }, 
            responsive: true, 
            maintainAspectRatio: false,
            
            // === ADICIONE ISTO AQUI ===
            animation: {
                animateRotate: true,
                duration: 2000
            }
        }
    });

            // 5. Gráfico de Frente (Progresso com Gradiente Neon)
            const ctxFg = canvasFg.getContext('2d');
            // Cria o gradiente horizontal (da esquerda para a direita)
            const gradient = ctxFg.createLinearGradient(0, 0, canvasFg.width, 0);
            // Define as paradas de cor para o efeito neon (Vermelho -> Amarelo -> Verde)
            gradient.addColorStop(0, 'rgba(255, 0, 60, 1)');    // Vermelho Neon
            gradient.addColorStop(0.5, 'rgba(255, 220, 0, 1)');  // Amarelo Neon
            gradient.addColorStop(1, 'rgba(0, 255, 150, 1)');    // Verde Neon

            if (gaugeChart) gaugeChart.destroy();
            gaugeChart = new Chart(ctxFg, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [visualPerc, 100 - visualPerc],
                        backgroundColor: [gradient, 'transparent'], // Usa o gradiente como cor de preenchimento
                        borderWidth: 0,
                        borderRadius: [8, 0],
                        ...thicknessConfig
                    }]
                },
                options: { 
                    plugins: { tooltip: { enabled: false } }, 
                    responsive: true, 
                    maintainAspectRatio: false,
                    animation: { animateRotate: true, duration: 3500 }
                }
            });
        }

        // ================= OUTROS GRÁFICOS (MANTIDOS) =================
        function updateHistoricoChart(ano) {
            const canvas = document.getElementById('historicoChart');
            if (!canvas) return;
            const dataVen = [], dataMeta = [];
            for (let i = 1; i <= 12; i++) {
                const mesNum = String(i).padStart(2, '0');
                const rowsMes = allData.filter(r => String(r[COLS.ANO]).trim() === ano && normalizarMes(r[COLS.MES]) === mesNum);
                dataVen.push(rowsMes.reduce((s,r) => s + parseValue(r[COLS.VALOR_PEDIDOS]), 0));
                dataMeta.push(rowsMes.reduce((s,r) => s + parseValue(r[COLS.META_MES]), 0));
            }
            if (historicoChart) historicoChart.destroy();
            historicoChart = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: MESES_NOMES_COMPLETOS.map(m => m.substring(0,3)),
                    datasets: [
                        { label: 'Vendas', data: dataVen, borderColor: '#22c55e', tension: 0.3, fill: true, backgroundColor: 'rgba(34, 197, 94, 0.1)' },
                        { label: 'Meta', data: dataMeta, borderColor: '#f59e0b', borderDash: [5,5], tension: 0.3 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        function updatePagamentoChart(filters) {
            const canvas = document.getElementById('pagamentoChart');
            const row = findDataRowForFilters(filters);
            const vals = [parseValue(row?.[COLS.VALORES_PIX]), parseValue(row?.[COLS.VALORES_CARTAO_CREDITO]), parseValue(row?.[COLS.VALORES_BOLETO])];
            if (pagamentoChart) pagamentoChart.destroy();
            pagamentoChart = new Chart(canvas.getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['PIX', 'Cartão', 'Boleto'], datasets: [{ data: vals, backgroundColor: ['#22c55e', '#3b82f6', '#a855f7'] }] },
                options: { maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' } } }
            });
        }

        function updateRegiaoChart(filters) {
            const canvas = document.getElementById('regiaoChart');
            const row = findDataRowForFilters(filters);
            const data = [parseValue(row?.[COLS.REGIAO_CENTRO_OESTE]), parseValue(row?.[COLS.REGIAO_NORDESTE]), parseValue(row?.[COLS.REGIAO_NORTE]), parseValue(row?.[COLS.REGIAO_SUDESTE]), parseValue(row?.[COLS.REGIAO_SUL])];
            if (regiaoChart) regiaoChart.destroy();
            regiaoChart = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: { labels: ['CO', 'NE', 'N', 'SE', 'S'], datasets: [{ label: 'Pedidos', data: data, backgroundColor: '#6366f1', borderRadius: 5 }] },
                options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function updateCompraChart(filters) {
            const canvas = document.getElementById('compraChart');
            const row = findDataRowForFilters(filters);
            if (compraChart) compraChart.destroy();
            compraChart = new Chart(canvas.getContext('2d'), {
                type: 'pie',
                data: { labels: ['Primeira', 'Recompra'], datasets: [{ data: [parseValue(row?.[COLS.PRIMEIRA_COMPRA]), parseValue(row?.[COLS.RECOMPRA])], backgroundColor: ['#f59e0b', '#0ea5e9'] }] },
                options: { maintainAspectRatio: false }
            });
        }

        function updateFranquiasCards(filters){
            const map = [{id:'bc',n:'FRA - Brasil Cacau'},{id:'cs',n:'FRA - Cacau Show'},{id:'kp',n:'FRA - Kopenhagen'},{id:'id',n:'IND - Industries'},{id:'pb',n:'PLB - PolyBee'}];
            map.forEach(f => {
                const rows = allData.filter(r => String(r[COLS.ANO]) === filters.ano && normalizarMes(r[COLS.MES]) === filters.mes && norm(r[COLS.LINHA]) === norm(f.n));
                const vPed = rows.reduce((s,r) => s + parseValue(r[COLS.VALOR_PEDIDOS]), 0);
                const vOrc = rows.reduce((s,r) => s + parseValue(r[COLS.VALOR_ORCAMENTOS]), 0);
                const qPed = rows.reduce((s,r) => s + parseValue(r[COLS.QTDE_PEDIDOS]), 0);
                document.getElementById(`${f.id}-qtd-orc`).textContent = formatNumber(rows.reduce((s,r) => s + parseValue(r[COLS.QTDE_ORCAMENTOS]), 0));
                document.getElementById(`${f.id}-val-orc`).textContent = formatCurrency(vOrc);
                document.getElementById(`${f.id}-qtd-ped`).textContent = formatNumber(qPed);
                document.getElementById(`${f.id}-val-ped`).textContent = formatCurrency(vPed);
                document.getElementById(`${f.id}-ticket`).textContent = formatCurrency(qPed > 0 ? vPed / qPed : 0);
                const conv = vOrc > 0 ? (vPed / vOrc) * 100 : 0;
                document.getElementById(`${f.id}-conversao`).textContent = formatPercent(conv);
                document.getElementById(`${f.id}-conversao-bar`).style.width = `${Math.min(conv, 100)}%`;
            });
        }

        // ================= MENUS E INTERFACE =================
        function toggleMenu(menuId, iconId) {
            const menu = document.getElementById(menuId);
            const icon = document.getElementById(iconId);
            document.querySelectorAll('.filter-dropdown').forEach(m => { if(m.id !== menuId) m.classList.remove('active'); });
            document.querySelectorAll('.ph-caret-down').forEach(i => { if(i.id !== iconId) i.style.transform = 'rotate(0deg)'; });
            menu.classList.toggle('active');
            icon.style.transform = menu.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function applyAndClose() {
            updateDashboard(true);
            document.getElementById('filterMenu').classList.remove('active');
            document.getElementById('filterIcon').style.transform = 'rotate(0deg)';
        }

        function toggleTheme() {
            const checkbox = document.getElementById('themeCheckbox');
            const root = document.documentElement;
            if (checkbox.checked) {
                root.style.setProperty('--bg-main', '#0a0a14'); root.style.setProperty('--card-bg', 'rgba(20, 20, 40, 0.7)'); root.style.setProperty('--text-primary', '#ffffff');
                document.getElementById('logoImg').src = 'logo-policryl-branco.png';
            } else {
                root.style.setProperty('--bg-main', '#f0f2f5'); root.style.setProperty('--card-bg', 'rgba(255, 255, 255, 0.9)'); root.style.setProperty('--text-primary', '#1e293b');
                document.getElementById('logoImg').src = 'logo-policryl-preto.png';
            }
            updateDashboard(false); // Atualiza cores dos gráficos
        }

        // ================= TIMER =================
        function startTimer(durationMs) {
            clearInterval(countdownTimer);
            timeLeft = durationMs / 1000;
            countdownTimer = setInterval(() => {
                const min = Math.floor(timeLeft / 60);
                const sec = Math.floor(timeLeft % 60);
                document.getElementById('timerDisplay').innerText = `REFRESH EM: ${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
                if (--timeLeft < 0) { updateDashboard(true); startTimer(durationMs); }
            }, 1000);
        }

        function setNewInterval() {
            const msecs = parseInt(document.getElementById('updateInterval').value);
            localStorage.setItem('dashboardRefreshInterval', msecs);
            startTimer(msecs);
            document.getElementById('updateMenu').classList.remove('active');
            document.getElementById('updateIcon').style.transform = 'rotate(0deg)';
        }

        // ================= INICIALIZAÇÃO =================
        document.addEventListener('DOMContentLoaded', () => {
            const mesSelect = document.getElementById('filterMes');
            const currentMonth = new Date().getMonth();
            MESES_NOMES_COMPLETOS.forEach((nome, i) => {
                const opt = document.createElement('option'); opt.value = String(i + 1).padStart(2, '0'); opt.text = nome;
                if (i === currentMonth) opt.selected = true;
                mesSelect.appendChild(opt);
            });

            const savedInterval = localStorage.getItem('dashboardRefreshInterval');
            if (savedInterval) {
                document.getElementById('updateInterval').value = savedInterval;
                startTimer(parseInt(savedInterval));
            } else {
                startTimer(300000);
            }

            updateDashboard(true);
        });

        window.onclick = function(event) {
            if (!event.target.closest('.control-wrapper')) {
                document.querySelectorAll('.filter-dropdown').forEach(m => m.classList.remove('active'));
                document.querySelectorAll('.ph-caret-down').forEach(i => i.style.transform = 'rotate(0deg)');
            }
        }
    </script>
</body>
</html>
