<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Comercial - Policryl</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* === VARIÁVEIS DE TEMA === */
        :root {
            /* Cores Dark Mode (Padrão) */
            --bg-app: #0f0c29;
            --bg-radial: radial-gradient(circle at top center, #1a1a2e 0%, #0a0a14 100%);
            
            /* Glassmorphism */
            --card-bg: rgba(20, 20, 40, 0.75);
            --card-border: rgba(255, 255, 255, 0.08);
            --card-blur: blur(12px);

            /* Texto */
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;

            /* Cores de Acento (Neon) */
            --accent-primary: #6366f1; /* Roxo/Azul principal */
            --accent-success: #22c55e;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --accent-info: #0ea5e9;

            /* Cores Franquias */
            --color-bc: #ff6b35; 
            --color-cs: #8b4513; 
            --color-kp: #ff1493;
            --color-pb: #ffd700; 
            --color-id: #1e90ff;

            /* Fonte */
            --font-main: 'Inter', sans-serif;
            --radius: 16px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* Tema Light */
        body.light-theme {
            --bg-app: #f8fafc;
            --bg-radial: #f1f5f9;
            --card-bg: #ffffff;
            --card-border: rgba(0,0,0,0.1);
            --card-blur: none;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        /* === RESET === */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background: var(--bg-radial);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
            padding: 20px;
        }

        .container { max-width: 1600px; margin: 0 auto; }

        /* === LOADING OVERLAY === */
        .loading {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-app); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 15px; font-weight: 600; color: var(--accent-primary); }

        /* === HEADER === */
        .header {
            display: grid;
            grid-template-columns: 25% 50% 25%;
            align-items: center;
            height: 240px;
            margin-bottom: 30px;
            padding: 0 30px;
            background: var(--card-bg);
            backdrop-filter: var(--card-blur);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            box-shadow: var(--shadow);
        }

        .logo img { height: 60px; width: auto; object-fit: contain; }

        /* === GAUGE (CENTRO) === */
        .gauge-container {
            display: flex; flex-direction: column; 
            align-items: center; justify-content: flex-end;
            height: 100%; padding-bottom: 25px; position: relative;
        }
        
        .canvas-wrapper { 
            width: 320px; height: 160px; position: relative; 
        }

        /* Labels Laterais (0 e Meta) */
        .gauge-labels {
            position: absolute; bottom: 40px; width: 380px;
            display: flex; justify-content: space-between;
            font-size: 14px; font-weight: 800; color: var(--text-secondary);
        }

        .gauge-footer { text-align: center; margin-top: -20px; z-index: 2; }
        .gauge-main-value {
            font-size: 32px; font-weight: 900; color: var(--text-primary);
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.3); line-height: 1.2;
        }
        .gauge-sub-label { 
            font-size: 11px; text-transform: uppercase; letter-spacing: 1px; 
            color: var(--text-secondary); font-weight: 600; margin-top: 2px;
        }

        /* === CONTROLES (DIREITA - VERTICAL) === */
        .controls-area {
            display: flex; flex-direction: column; 
            align-items: flex-end; justify-content: center;
            gap: 16px; height: 100%;
        }

        /* 1. Toggle Theme (Estilo Pílula) */
        .theme-switch {
            width: 56px; height: 28px;
            background: var(--accent-primary);
            border-radius: 50px;
            cursor: pointer; position: relative;
            transition: 0.3s;
            box-shadow: 0 0 10px rgba(99,102,241,0.3);
        }
        body.light-theme .theme-switch { background: #cbd5e1; box-shadow: none; }

        .theme-knob {
            width: 22px; height: 22px; background: #fff; border-radius: 50%;
            position: absolute; top: 3px; left: 3px;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            transform: translateX(28px); /* Dark Mode: Direita */
            display: flex; align-items: center; justify-content: center;
            color: var(--accent-primary);
        }
        body.light-theme .theme-knob { transform: translateX(0); color: var(--accent-warning); }
        
        .icon-moon { display: block; font-size: 13px; }
        .icon-sun { display: none; font-size: 13px; }
        body.light-theme .icon-moon { display: none; }
        body.light-theme .icon-sun { display: block; }

        /* 2. Filtro (Botão + Dropdown) */
        .filter-wrapper { position: relative; width: 160px; }
        
        .btn-filter {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--accent-primary);
            color: var(--text-primary);
            padding: 10px 15px; border-radius: 8px;
            font-family: 'Inter'; font-weight: 600; font-size: 13px;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s;
        }
        .btn-filter:hover { background: var(--accent-primary); color: #fff; box-shadow: 0 0 15px rgba(99,102,241,0.4); }

        .filter-dropdown {
            position: absolute; top: 120%; right: 0;
            background: #1a1a2e; /* Fundo sólido para leitura */
            border: 1px solid var(--card-border);
            padding: 15px; border-radius: 12px;
            width: 260px; display: none; z-index: 100;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }
        .filter-dropdown.active { display: block; animation: fadeIn 0.2s ease; }

        .filter-group { margin-bottom: 12px; }
        .filter-group label { display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 5px; font-weight: 600; text-transform: uppercase; }
        
        .glass-select {
            width: 100%; background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); color: #fff;
            padding: 8px; border-radius: 6px; outline: none; cursor: pointer;
        }
        body.light-theme .glass-select { background: #f1f5f9; color: #333; border-color: #ccc; }

        .btn-apply {
            width: 100%; background: var(--accent-primary); border: none; padding: 10px;
            color: #fff; font-weight: 700; border-radius: 6px; cursor: pointer; margin-top: 5px;
        }

        /* 3. Refresh Selector & Timer */
        .refresh-wrapper { width: 160px; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        
        .refresh-select {
            background: rgba(255,255,255,0.05); border: 1px solid var(--card-border);
            color: var(--text-primary); padding: 6px 10px; border-radius: 6px;
            font-size: 12px; cursor: pointer; outline: none; text-align: right; width: 100%;
        }
        body.light-theme .refresh-select { background: #fff; border-color: #ccc; color: #333; }

        .timer-display { font-family: monospace; font-size: 12px; color: var(--accent-primary); font-weight: 700; }

        /* === KPIS GRID === */
        .kpis-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }

        .kpi-card {
            background: var(--card-bg); backdrop-filter: var(--card-blur);
            border-radius: 18px; padding: 24px; border: 1px solid var(--card-border);
            position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center;
            transition: transform 0.2s; box-shadow: var(--shadow);
        }
        .kpi-card:hover { transform: translateY(-3px); }

        /* Glow colorido na borda esquerda */
        .kpi-card::before { content:''; position:absolute; top:0; bottom:0; left:0; width:4px; }
        .kpi-card.primary::before { background: var(--accent-primary); box-shadow: 2px 0 10px var(--accent-primary); }
        .kpi-card.success::before { background: var(--accent-success); box-shadow: 2px 0 10px var(--accent-success); }
        .kpi-card.warning::before { background: var(--accent-warning); box-shadow: 2px 0 10px var(--accent-warning); }
        .kpi-card.danger::before  { background: var(--accent-danger);  box-shadow: 2px 0 10px var(--accent-danger); }
        .kpi-card.info::before    { background: var(--accent-info);    box-shadow: 2px 0 10px var(--accent-info); }

        .kpi-label { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 0.5px; }
        .kpi-value { font-size: 26px; font-weight: 800; color: var(--text-primary); margin-bottom: 5px; }
        .kpi-subtitle { font-size: 12px; color: var(--text-muted); }
        .highlight { color: var(--accent-success); text-shadow: 0 0 10px rgba(34, 197, 94, 0.3); }

        /* === FRANQUIAS GRID === */
        .franquias-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 30px; }

        .franquia-card {
            background: var(--card-bg); backdrop-filter: var(--card-blur);
            border-radius: 18px; padding: 20px; border: 1px solid var(--card-border);
            position: relative; overflow: hidden;
        }
        /* Top Glow da Marca */
        .franquia-card::after { content:''; position:absolute; top:0; left:0; right:0; height:3px; background:var(--brand-color); box-shadow: 0 0 15px var(--brand-color); }
        
        .franquia-card.bc { --brand-color: var(--color-bc); }
        .franquia-card.cs { --brand-color: var(--color-cs); }
        .franquia-card.kp { --brand-color: var(--color-kp); }
        .franquia-card.pb { --brand-color: var(--color-pb); }
        .franquia-card.id { --brand-color: var(--color-id); }

        .fra-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .fra-icon {
            width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 800; color: #fff;
            background: linear-gradient(135deg, var(--brand-color), rgba(0,0,0,0.8));
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .fra-title { font-size: 13px; font-weight: 700; color: var(--text-primary); text-transform: uppercase; }

        .metric-row { display: flex; justify-content: space-between; padding: 6px 0; align-items: baseline; }
        .metric-lbl { font-size: 10px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; }
        .metric-val { font-size: 13px; font-weight: 700; color: var(--text-primary); }
        .metric-val.money { color: var(--accent-success); font-size: 14px; }

        .conv-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .conv-fill { height: 100%; background: var(--brand-color); border-radius: 4px; box-shadow: 0 0 8px var(--brand-color); transition: width 1s; }

        /* === SEÇÃO GRÁFICOS === */
        .section-row { margin-bottom: 30px; }
        .chart-card {
            background: var(--card-bg); backdrop-filter: var(--card-blur);
            border-radius: 20px; padding: 25px; border: 1px solid var(--card-border);
            box-shadow: var(--shadow);
        }
        .chart-title { font-size: 15px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
        .chart-title i { font-size: 18px; color: var(--accent-primary); }

        .historico-chart { height: 350px; width: 100%; }
        .charts-3-col { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .chart-container-small { position: relative; height: 220px; }

        @keyframes fadeIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }

        /* === RESPONSIVO === */
        @media (min-width: 1920px) {
            .container { max-width: 1800px; }
            .header { height: 280px; }
            .canvas-wrapper { width: 380px; height: 190px; }
        }
        @media (max-width: 1400px) {
            .kpis-grid, .franquias-grid { grid-template-columns: repeat(3, 1fr); }
            .charts-3-col { grid-template-columns: 1fr 1fr; }
            .charts-3-col > div:last-child { grid-column: span 2; }
        }
    </style>
</head>
<body>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Carregando dados...</div>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo">
                <img src="logo-policryl-branco.png" alt="Policryl">
            </div>

            <div class="gauge-container">
                <div class="canvas-wrapper">
                    <canvas id="gaugeChart"></canvas>
                </div>
                <div class="gauge-labels">
                    <span>R$ 0</span>
                    <span id="gaugeMetaLabel">R$ --</span>
                </div>
                <div class="gauge-footer">
                    <div class="gauge-main-value" id="gaugeValor">R$ 0,00</div>
                    <div class="gauge-sub-label">Total Vendido (Ano)</div>
                </div>
            </div>

            <div class="controls-area">
                
                <div class="theme-switch" onclick="toggleTheme()" title="Mudar Tema">
                    <div class="theme-knob">
                        <i class="ph-bold ph-moon icon-moon"></i>
                        <i class="ph-bold ph-sun icon-sun"></i>
                    </div>
                </div>

                <div class="filter-wrapper">
                    <button class="btn-filter" onclick="toggleMenu()">
                        FILTRAR <i class="ph-bold ph-caret-down"></i>
                    </button>
                    
                    <div class="filter-dropdown" id="filter-menu">
                        <div class="filter-group">
                            <label>ANO</label>
                            <select id="filterAno" class="glass-select"></select>
                        </div>
                        <div class="filter-group">
                            <label>MÊS</label>
                            <select id="filterMes" class="glass-select"></select>
                        </div>
                        <div class="filter-group">
                            <label>LINHA</label>
                            <select id="filterLinha" class="glass-select">
                                <option value="todas">Todas as Linhas</option>
                                <option value="FRA - Brasil Cacau">Brasil Cacau</option>
                                <option value="FRA - Cacau Show">Cacau Show</option>
                                <option value="FRA - Kopenhagen">Kopenhagen</option>
                                <option value="IND - Industries">Industries</option>
                                <option value="PLB - PolyBee">PolyBee</option>
                            </select>
                        </div>
                        <button class="btn-apply" onclick="applyFilters()">Aplicar Filtros</button>
                    </div>
                </div>

                <div class="refresh-wrapper">
                    <select id="refreshSelect" class="refresh-select" onchange="updateRefreshTime()">
                        <option value="30">30 seg (Teste)</option>
                        <option value="60">1 min</option>
                        <option value="300">5 min</option>
                        <option value="600" selected>10 min</option>
                        <option value="1800">30 min</option>
                    </select>
                    <div class="timer-display" id="countdown">Refresh em: 00:00</div>
                </div>
            </div>
        </header>

        <div class="kpis-grid">
            <div class="kpi-card primary">
                <div class="kpi-label">Meta do Mês</div>
                <div class="kpi-value" id="metaMes">R$ 0</div>
                <div class="kpi-subtitle" id="mesRef">--/--</div>
            </div>
            <div class="kpi-card primary">
                <div class="kpi-label">Meta Diária (Acum.)</div>
                <div class="kpi-value" id="metaDia">R$ 0</div>
                <div class="kpi-subtitle">Esperado até hoje</div>
            </div>
            <div class="kpi-card success">
                <div class="kpi-label">Valor em Vendas</div>
                <div class="kpi-value highlight" id="valorVendas">R$ 0</div>
                <div class="kpi-subtitle">Total Faturado no Mês</div>
            </div>
            <div class="kpi-card danger">
                <div class="kpi-label">Pedidos em Atraso</div>
                <div class="kpi-value" id="pedidosAtraso">0</div>
                <div class="kpi-subtitle">Atenção (Geral)</div>
            </div>
            <div class="kpi-card warning">
                <div class="kpi-label">Pedidos à Liberar</div>
                <div class="kpi-value" id="pedidosLiberar">0</div>
                <div class="kpi-subtitle">Aguardando Aprovação</div>
            </div>
            <div class="kpi-card info">
                <div class="kpi-label">Pedidos Faturados</div>
                <div class="kpi-value" id="pedidosFaturados">0</div>
                <div class="kpi-subtitle">Mês Atual</div>
            </div>
        </div>

        <div class="franquias-grid" id="franchise-container">
            </div>

        <div class="section-row">
            <div class="chart-card">
                <div class="chart-title"><i class="ph-bold ph-chart-line-up"></i> Histórico Mensal</div>
                <div class="historico-chart">
                    <canvas id="historicoChart"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-3-col">
            <div class="chart-card">
                <div class="chart-title"><i class="ph-bold ph-credit-card"></i> Pagamentos</div>
                <div class="chart-container-small"><canvas id="pagamentoChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-title"><i class="ph-bold ph-map-pin"></i> Regiões</div>
                <div class="chart-container-small"><canvas id="regiaoChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-title"><i class="ph-bold ph-arrows-counter-clockwise"></i> Recompra</div>
                <div class="chart-container-small"><canvas id="compraChart"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKstKflONSWvQ6xfVkMdM53mveopLXVGNv9CyQT0kRbjdI7IGIVzvvMPLSXNyQ-xZTQEvDmKr1jI_I/pub?gid=1199309873&single=true&output=csv',
            METAS: {
                "2024": 8500000.00,
                "2025": 7897826.66,
                "2026": 10000000.00
            }
        };

        const COLS = {
            ANO:0, MES:1, LINHA:2, META_MES:3, VALOR_ORCAMENTOS:7, VALOR_PEDIDOS:14, 
            QTDE_ORCAMENTOS:6, QTDE_PEDIDOS:13,
            PEDIDOS_PIX:19, VALORES_PIX:20, PEDIDOS_CARTAO_CREDITO:21, VALORES_CARTAO_CREDITO:22, PEDIDOS_BOLETO:23, VALORES_BOLETO:24,
            PEDIDOS_ATRASADOS:25, PEDIDOS_A_LIBERAR:27, PEDIDOS_FATURADOS_MES:28,
            REGIAO_CENTRO_OESTE:34, REGIAO_NORDESTE:35, REGIAO_NORTE:36, REGIAO_SUDESTE:37, REGIAO_SUL:38,
            PRIMEIRA_COMPRA:32, RECOMPRA:33
        };

        let allData = [], gaugeChart, historicoChart, pagamentoChart, regiaoChart, compraChart, refreshTimer, secondsLeft = 600;

        document.addEventListener('DOMContentLoaded', () => {
            initFilters(); initGauge(); loadSettings(); fetchSheetData(); startTimer();
        });

        // --- DADOS ---
        async function fetchSheetData() {
            try {
                document.getElementById('loading').style.display='flex';
                const res = await fetch(`${CONFIG.CSV_URL}&cb=${Date.now()}`);
                const txt = await res.text();
                const rows = csvToArray(txt);
                if (rows.length > 1) { allData = rows.slice(1); updateDashboard(); }
            } catch (e) { console.error(e); } finally { document.getElementById('loading').style.display='none'; }
        }

        function updateDashboard() {
            const f = getCurrentFilters();
            
            // Filtro Principal (KPIs Mensais)
            const filtered = allData.filter(r => {
                const ra = String(r[COLS.ANO]).trim(), rm = normalizarMes(r[COLS.MES]);
                const rl = String(r[COLS.LINHA]).trim().toLowerCase();
                return (f.ano==='todos'||ra===f.ano) && (f.mes==='todos'||rm===f.mes) && (f.linha==='todas'||rl===f.linha.toLowerCase());
            });

            // Somas
            let tMeta=0, tVend=0, tFat=0;
            filtered.forEach(r => {
                tMeta += parseValue(r[COLS.META_MES]);
                tVend += parseValue(r[COLS.VALOR_PEDIDOS]);
                tFat += parseValue(r[COLS.PEDIDOS_FATURADOS_MES]);
            });

            // KPIs Geral (Atraso/Liberar ignoram mês, respeitam linha)
            const gData = allData.filter(r => f.linha==='todas' || String(r[COLS.LINHA]).trim().toLowerCase()===f.linha.toLowerCase());
            const tAtraso = gData.reduce((a,r)=>a+parseValue(r[COLS.PEDIDOS_ATRASADOS]),0);
            const tLib = gData.reduce((a,r)=>a+parseValue(r[COLS.PEDIDOS_A_LIBERAR]),0);

            // Meta Dia
            let mDia = 0;
            if(f.mes!=='todos' && f.ano!=='todos'){
                const dias = new Date(f.ano, f.mes, 0).getDate();
                const hoje = new Date(), isCurr = (parseInt(f.mes)===(hoje.getMonth()+1) && parseInt(f.ano)===hoje.getFullYear());
                const corr = isCurr ? hoje.getDate() : dias;
                mDia = (tMeta/dias)*corr;
            } else { mDia = tMeta; } // Se "Todos", meta dia = meta total

            // UI
            setText('metaMes', formatCurrency(tMeta)); setText('metaDia', formatCurrency(mDia));
            setText('valorVendas', formatCurrency(tVend)); setText('pedidosFaturados', formatNumber(tFat));
            setText('pedidosAtraso', formatNumber(tAtraso)); setText('pedidosLiberar', formatNumber(tLib));
            setText('mesRef', `${f.mes==='todos'?'Todos':f.mes}/${f.ano==='todos'?'Todos':f.ano}`);

            updateFranquias(allData, f);
            updateGauge(f.ano);
            updateCharts(filtered, f.ano);
        }

        function updateFranquias(data, f) {
            const box = document.getElementById('franchise-container'); box.innerHTML='';
            const ids = [
                {c:'bc',n:'FRA - Brasil Cacau'}, {c:'cs',n:'FRA - Cacau Show'},
                {c:'kp',n:'FRA - Kopenhagen'}, {c:'id',n:'IND - Industries'},
                {c:'pb',n:'PLB - PolyBee'}
            ];
            ids.forEach(i => {
                const rows = data.filter(r => {
                    const ra=String(r[COLS.ANO]).trim(), rm=normalizarMes(r[COLS.MES]);
                    return (f.ano==='todos'||ra===f.ano) && (f.mes==='todos'||rm===f.mes) && String(r[COLS.LINHA]).trim().toLowerCase()===i.n.toLowerCase();
                });
                let vOrc=0, vPed=0, qPed=0, qOrc=0;
                rows.forEach(r=>{ 
                    vOrc+=parseValue(r[COLS.VALOR_ORCAMENTOS]); vPed+=parseValue(r[COLS.VALOR_PEDIDOS]); 
                    qPed+=parseValue(r[COLS.QTDE_PEDIDOS]); qOrc+=parseValue(r[COLS.QTDE_ORCAMENTOS]); 
                });
                const tick = qPed>0?vPed/qPed:0; const conv = vOrc>0?(vPed/vOrc)*100:0;
                
                box.innerHTML += `
                <div class="franquia-card ${i.c}">
                    <div class="fra-header">
                        <div class="fra-icon">${i.c.toUpperCase()}</div>
                        <div class="fra-title">${i.n.replace(/FRA - |IND - |PLB - /g,'')}</div>
                    </div>
                    <div class="fra-body">
                        <div class="metric-row"><span class="metric-lbl">Nº Orç.</span><span class="metric-val">${formatNumber(qOrc)}</span></div>
                        <div class="metric-row"><span class="metric-lbl">Val. Orç.</span><span class="metric-val">${formatCurrency(vOrc)}</span></div>
                        <div class="metric-row"><span class="metric-lbl">Venda</span><span class="metric-val money">${formatCurrency(vPed)}</span></div>
                        <div class="metric-row"><span class="metric-lbl">Ticket</span><span class="metric-val">${formatCurrency(tick)}</span></div>
                        <div class="metric-row"><span class="metric-lbl">Conversão</span><span class="metric-val" style="color:${conv>=30?'var(--accent-success)':'#fff'}">${conv.toFixed(1)}%</span></div>
                        <div class="conv-bar"><div class="conv-fill" style="width:${Math.min(conv,100)}%"></div></div>
                    </div>
                </div>`;
            });
        }

        function updateGauge(ano) {
            let meta = 0;
            if(ano === 'todos') Object.values(CONFIG.METAS).forEach(v => meta += v);
            else meta = CONFIG.METAS[ano] || 10000000;

            const rows = allData.filter(r => (ano==='todos'||String(r[COLS.ANO]).trim()===ano));
            const total = rows.reduce((a,r)=>a+parseValue(r[COLS.VALOR_PEDIDOS]),0);
            
            // "Filling Bar" Logic
            let pct = (total/meta)*100; if(pct>100)pct=100;
            
            // Cor Dinâmica (Gradiente)
            const ctx = document.getElementById('gaugeChart').getContext('2d');
            let grad = ctx.createLinearGradient(0, 0, 300, 0);
            grad.addColorStop(0, '#ef4444'); grad.addColorStop(0.5, '#f59e0b'); grad.addColorStop(1, '#22c55e');

            if(gaugeChart) gaugeChart.destroy();
            gaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [pct, 100-pct],
                        backgroundColor: [grad, 'rgba(255,255,255,0.05)'],
                        borderWidth: 0, borderRadius: [10, 0]
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    rotation: -90, circumference: 180, cutout: '85%',
                    plugins: { legend:false, tooltip:false }
                }
            });

            setText('gaugeValor', formatCurrency(total));
            setText('gaugeMetaLabel', formatShortCurrency(meta));
        }

        function updateCharts(filtered, ano) {
            // Histórico
            if(historicoChart) historicoChart.destroy();
            const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
            let dataOrc=[], dataVen=[], dataMet=[];
            
            for(let i=1; i<=12; i++){
                const m = String(i).padStart(2,'0');
                const rows = allData.filter(r=>(ano==='todos'||String(r[COLS.ANO])===ano) && normalizarMes(r[COLS.MES])===m);
                dataOrc.push(rows.reduce((a,r)=>a+parseValue(r[COLS.VALOR_ORCAMENTOS]),0));
                dataVen.push(rows.reduce((a,r)=>a+parseValue(r[COLS.VALOR_PEDIDOS]),0));
                dataMet.push(rows.reduce((a,r)=>a+parseValue(r[COLS.META_MES]),0));
            }

            const common = { borderWidth:3, pointRadius:3, tension:0.3 };
            historicoChart = new Chart(document.getElementById('historicoChart'), {
                type: 'line',
                data: {
                    labels: meses,
                    datasets: [
                        { label:'Orçamentos', data:dataOrc, borderColor:'#6366f1', backgroundColor:'rgba(99,102,241,0.1)', fill:true, ...common },
                        { label:'Vendas', data:dataVen, borderColor:'#22c55e', backgroundColor:'rgba(34,197,94,0.1)', fill:true, ...common },
                        { label:'Meta', data:dataMet, borderColor:'#f59e0b', borderDash:[5,5], fill:false, ...common, borderWidth:2 }
                    ]
                },
                options: { 
                    responsive:true, maintainAspectRatio:false, 
                    plugins:{ legend:{position:'top', labels:{color:'#94a3b8', usePointStyle:true} } },
                    scales: { x:{grid:{color:'rgba(255,255,255,0.05)'}}, y:{grid:{color:'rgba(255,255,255,0.05)'}} }
                }
            });

            // Pagamentos
            if(pagamentoChart) pagamentoChart.destroy();
            let pix=0, cred=0, bol=0;
            filtered.forEach(r=>{ pix+=parseValue(r[COLS.VALORES_PIX]); cred+=parseValue(r[COLS.VALORES_CARTAO_CREDITO]); bol+=parseValue(r[COLS.VALORES_BOLETO]); });
            pagamentoChart = new Chart(document.getElementById('pagamentoChart'), {
                type: 'doughnut',
                data: { labels:['PIX','Crédito','Boleto'], datasets:[{data:[pix,cred,bol], backgroundColor:['#22c55e','#3b82f6','#a855f7'], borderWidth:0}] },
                options: { responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{legend:{position:'bottom',labels:{color:'#94a3b8', usePointStyle:true}}} }
            });

            // Regiões
            if(regiaoChart) regiaoChart.destroy();
            let regs = { 'CO':0, 'NE':0, 'N':0, 'SE':0, 'S':0 };
            filtered.forEach(r=>{ 
                regs.CO+=parseValue(r[COLS.REGIAO_CENTRO_OESTE]); regs.NE+=parseValue(r[COLS.REGIAO_NORDESTE]); 
                regs.N+=parseValue(r[COLS.REGIAO_NORTE]); regs.SE+=parseValue(r[COLS.REGIAO_SUDESTE]); regs.S+=parseValue(r[COLS.REGIAO_SUL]); 
            });
            // Sort
            const sorted = Object.entries(regs).sort(([,a],[,b])=>b-a);
            regiaoChart = new Chart(document.getElementById('regiaoChart'), {
                type: 'bar',
                data: { labels: sorted.map(x=>x[0]), datasets:[{data:sorted.map(x=>x[1]), backgroundColor:'#6366f1', borderRadius:4}] },
                options: { responsive:true, maintainAspectRatio:false, indexAxis:'y', plugins:{legend:false}, scales:{x:{grid:{color:'rgba(255,255,255,0.05)'}}} }
            });

            // Compra
            if(compraChart) compraChart.destroy();
            let prim=0, re=0;
            filtered.forEach(r=>{ prim+=parseValue(r[COLS.PRIMEIRA_COMPRA]); re+=parseValue(r[COLS.RECOMPRA]); });
            compraChart = new Chart(document.getElementById('compraChart'), {
                type: 'pie',
                data: { labels:['1ª Compra','Recompra'], datasets:[{data:[prim,re], backgroundColor:['#f59e0b','#0ea5e9'], borderWidth:0}] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom',labels:{color:'#94a3b8', usePointStyle:true}}} }
            });
        }

        // --- UTILS ---
        function initFilters(){
            const sa=document.getElementById('filterAno'), sm=document.getElementById('filterMes');
            sa.add(new Option('Todos','todos')); [2024,2025,2026,2027].forEach(a=>{ let o=new Option(a,a); if(a===new Date().getFullYear())o.selected=true; sa.add(o); });
            sm.add(new Option('Todos','todos')); ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'].forEach((m,i)=>{ let v=String(i+1).padStart(2,'0'); let o=new Option(m,v); if((i+1)===new Date().getMonth()+1)o.selected=true; sm.add(o); });
        }
        function toggleMenu(){ document.getElementById('filter-menu').classList.toggle('active'); }
        function applyFilters(){ updateDashboard(); document.getElementById('filter-menu').classList.remove('active'); }
        function initGauge(){ updateGauge('2026'); }
        function getCurrentFilters(){ return {ano:document.getElementById('filterAno').value, mes:document.getElementById('filterMes').value, linha:document.getElementById('filterLinha').value}; }
        function formatShortCurrency(v){ return 'R$ '+(v/1000000).toLocaleString('pt-BR',{maximumFractionDigits:1})+'M'; }
        function setText(id,t){ const el=document.getElementById(id); if(el)el.textContent=t; }
        function csvToArray(t){ return t.split(/\r?\n/).filter(l=>l.length>0).map(l=>{ const o=[]; let c='',q=false; for(let i=0;i<l.length;i++){ if(l[i]==='"'){if(q&&l[i+1]==='"'){c+='"';i++}else q=!q;} else if(l[i]===','&&!q){o.push(c);c='';} else c+=l[i]; } o.push(c); return o; }); }
        function parseValue(v){ if(!v)return 0; if(typeof v==='number')return v; return parseFloat(String(v).replace('R$','').replace(/\./g,'').replace(',','.').trim())||0; }
        function formatCurrency(v){ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0); }
        function formatNumber(v){ return new Intl.NumberFormat('pt-BR').format(v||0); }
        function normalizarMes(m){ if(m==='todos')return 'todos'; const n=parseInt(m,10); return isNaN(n)?'01':String(n).padStart(2,'0'); }

        // --- TIMER & THEME ---
        function loadSettings(){ const t=localStorage.getItem('d_sec'); if(t){secondsLeft=parseInt(t); document.getElementById('refreshSelect').value=t;} const m=localStorage.getItem('d_th'); if(m==='light')toggleTheme(true); }
        function updateRefreshTime(){ const v=document.getElementById('refreshSelect').value; secondsLeft=parseInt(v); localStorage.setItem('d_sec',v); startTimer(); }
        function startTimer(){ clearInterval(refreshTimer); const d=document.getElementById('countdown'); let c=parseInt(document.getElementById('refreshSelect').value); refreshTimer=setInterval(()=>{ c--; let m=Math.floor(c/60), s=c%60; d.textContent=`Refresh em: ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; if(c<=0){fetchSheetData(); c=parseInt(document.getElementById('refreshSelect').value);} },1000); }
        function toggleTheme(f=false){ 
            const b=document.body, l=f||!b.classList.contains('light-theme');
            const knob = document.querySelector('.theme-knob');
            if(l){b.classList.add('light-theme'); knob.style.transform='translateX(0)'; localStorage.setItem('d_th','light');}
            else{b.classList.remove('light-theme'); knob.style.transform='translateX(28px)'; localStorage.setItem('d_th','dark');}
            if(gaugeChart) gaugeChart.update();
        }
    </script>
</body>
</html>
